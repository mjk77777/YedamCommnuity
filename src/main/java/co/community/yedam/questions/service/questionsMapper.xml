<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="co.community.yedam.questions.service.questionsMapper">


	<select id="questionsSelectList"
		resultType="co.community.yedam.questions.service.questionsVO">
		SELECT * FROM QUESTIONS ORDER BY QUESTIONS_ID DESC
			</select>
			
	<select id="commentList" 
		resultType="co.community.yedam.questions.service.questionsVO">
		SELECT * FROM QUESTIONS_COMMENT WHERE QUESTIONS_ID = #{questionsId}
		ORDER BY COMMENT_NUM ASC
		
		</select>
	

	<!-- 동적 sql예시. id만 들어오면 찾아주고, 둘 다 들어오면 로그인 처리해주는 거 -->
	<select id="questionsSelect"
		resultType="co.community.yedam.questions.service.questionsVO">
		SELECT * FROM QUESTIONS
		WHERE QUESTIONS_ID = #{questionsId}

	</select>

	

	<insert id="questionsInsert">
		<selectKey keyProperty="questionsId" resultType="int"
			order="BEFORE">
			SELECT CASE WHEN MAX(QUESTIONS_ID) IS NULL THEN 1
		    ELSE
			MAX(QUESTIONS_ID) + 1 END AS ID
			FROM QUESTIONS
		</selectKey>
		INSERT INTO QUESTIONS (QUESTIONS_ID,QUESTIONS_TITLE,QUESTIONS_CONTENT,QUESTIONS_DATE,MEMBER_ID)
		VALUES (#{questionsId},#{questionsTitle},#{questionsContent},SYSDATE,#{memberId})
		
	</insert>
	
	<insert id="commentInsert">
		<selectKey keyProperty="commentNum" resultType="int" order="BEFORE">
			SELECT CASE WHEN MAX(COMMENT_NUM) IS NULL THEN 1
			ELSE
			MAX(COMMENT_NUM) + 1 END AS NUM
			FROM QUESTIONS_COMMENT
		</selectKey>
			INSERT INTO QUESTIONS_COMMENT (COMMENT_NUM, QUESTIONS_ID, COMMENT_ID, COMMENT_DATE,COMMENT_BODY)
			VALUES(#{commentNum}, #{questionsId}, #{commentId}, SYSDATE, #{commentBody})
	</insert>

	<update id="questionsUpdate" parameterType="co.community.yedam.questions.service.questionsVO">
		UPDATE QUESTIONS
		
		<set>
		<if test="questionsTitle != null">questions_title = #{questionsTitle},</if>
		<if test="questionsContent != null">questions_content = #{questionsContent},</if>
		<if test="questionsDate != null">questions_date = #{questionsDate}</if>
		</set>
		WHERE QUESTIONS_ID = #{questionsId}
	</update>
	

	<delete id="questionsDelete" parameterType="co.community.yedam.questions.service.questionsVO">
		DELETE FROM QUESTIONS
		WHERE
		QUESTIONS_ID = #{questionsId}
	</delete>
	
	<!-- 댓글 삭제 -->
	<delete id="delComment" parameterType="co.community.yedam.questions.service.questionsVO">
		DELETE FROM QUESTIONS_COMMENT
		WHERE COMMENT_NUM = #{commentNum}
	</delete>
	
	<!-- 댓글 수정 -->
	<update id="updateCom" parameterType="co.community.yedam.questions.service.questionsVO">
		UPDATE QUESTIONS_COMMENT
		<set>
		comment_date = SYSDATE,
		<if test="commentBody != null"></if>
		comment_body = #{commentBody}
		</set>
		WHERE comment_num = #{commentNum}
	</update>
	
	 <!-- 조회수 증가 -->
	<update id="updateHit" parameterType="co.community.yedam.questions.service.questionsVO">
		UPDATE QUESTIONS
		SET HIT = HIT +1
		WHERE QUESTIONS_ID = #{questionsId}
	</update>
	
	<select id="questionsSearchList" resultType="co.community.yedam.questions.service.questionsVO">
		SELECT * FROM questions
		WHERE 
		<if test="key == 0">1 = 1</if>
		<if test="key == 1"> questions_TITLE LIKE '%'|| #{val} ||'%'</if>
		<if test="key == 2"> MEMBER_ID LIKE '%'|| #{val} ||'%'</if>
		<if test="key == 3"> questions_content LIKE '%'|| #{val} ||'%'</if>
		ORDER BY questions_ID DESC
	</select>
	
	



</mapper>